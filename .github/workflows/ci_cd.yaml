name: CI_CD
on: 
  workflow_dispatch: 
    inputs:
      environment:
        description: " Choose dev/test/prod environment"
        required: false
        default: "dev"
  push:
    paths-ignore:
      - .github/workflows/*

env:
  DEPLOY_ENV: dev

jobs:
  lint:
    runs-on: ubuntu-latest
  test:
    runs-on: ubuntu-latest
  terraform_infra:
    runs-on: ubuntu-latest

  deploy_kuberntes:
    runs-on: ubuntu-latest

    steps:
      - name: Get code
        uses: actions/checkout@v4

      - name: Install kubectl binary on runner and add to PATH
        uses: azure/setup-kubectl@v4
        with: 
          version: 'v1.29.0'
          # jeśli klaster ma v1.28, to kubectl może być v1.28.x lub v1.29.x.

      - name: Install Kustomize on runner
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Get secrets from Github Secrets
        run: |
          echo "POSTGRES_USER_B64=$(echo -n ${{ secrets.POSTGRES_USER }}| base64)" >> GITHUB_ENV
          echo "POSTGRES_PASS_B64=$(echo -n ${{ secrets.POSTGRES_PASS }} | base64)" >> $GITHUB_ENV
          echo "RDS_USER_B64=$(echo -n ${{ secrets.RDS_USER }}| base64)" >> GITHUB_ENV
          echo "RDS_PASS_B64=$(echo -n ${{ secrets.RDS_PASS }} | base64)" >> $GITHUB_ENV
        # $GITHUB_ENV do ustawiania zmiennych środowiskowych na czas trwania joba

      - name: Apply manifests
        run: |
          kubectl apply -k k8s-preg/overlays/$DEPLOY_ENV